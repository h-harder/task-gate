<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b5cab" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Task Gate" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <title>Task Gate</title>

  <style>
    :root { --bg:#0b1020; --card:#111a33; --muted:#9fb0ff; --text:#eef2ff; --accent:#58a6ff; --good:#3ddc97; --bad:#ff6b6b; }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% 0%, #1a2b66 0%, var(--bg) 55%);
      color:var(--text); padding:16px 16px 40px;
    }
    .wrap { max-width: 760px; margin: 0 auto; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px; }
    h1 { font-size: 22px; margin: 10px 0 2px; letter-spacing: .2px; }
    .sub { color: rgba(238,242,255,.8); font-size: 13px; margin:0 0 14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .card h2 { margin:0 0 8px; font-size: 14px; color: rgba(238,242,255,.9); }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(238,242,255,.9);
      font-size: 12px;
    }
    .pill strong { color: var(--text); }
    .btn {
      appearance:none; border:0; cursor:pointer;
      background: rgba(88,166,255,.16);
      color: var(--text);
      border: 1px solid rgba(88,166,255,.35);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 650;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      background: linear-gradient(180deg, rgba(88,166,255,.42), rgba(88,166,255,.18));
      border-color: rgba(88,166,255,.55);
    }
    .btn.good {
      background: linear-gradient(180deg, rgba(61,220,151,.40), rgba(61,220,151,.14));
      border-color: rgba(61,220,151,.55);
    }
    .btn.bad {
      background: linear-gradient(180deg, rgba(255,107,107,.34), rgba(255,107,107,.12));
      border-color: rgba(255,107,107,.55);
    }
    .btn:disabled { opacity:.45; cursor:not-allowed; transform:none; }
    input, select {
      width: 100%;
      background: rgba(0,0,0,.25);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
    }
    label { font-size: 12px; color: rgba(238,242,255,.75); display:block; margin: 10px 0 6px; }
    .tasks { display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .task {
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .task input[type="checkbox"] { width: 18px; height: 18px; }
    .task .title { flex:1; line-height: 1.25; }
    .task .meta { display:flex; gap:8px; align-items:center; }
    .tag {
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(238,242,255,.85);
      background: rgba(255,255,255,.06);
      user-select:none;
    }
    .tag.req { border-color: rgba(61,220,151,.35); background: rgba(61,220,151,.12); }
    .tag.opt { border-color: rgba(159,176,255,.35); background: rgba(159,176,255,.10); }
    .tiny { font-size: 12px; color: rgba(238,242,255,.75); }
    .split { display:grid; grid-template-columns: 1.15fr .85fr; gap:12px; }
    @media (max-width: 820px) { .split { grid-template-columns: 1fr; } }

    /* ‚ÄúGate‚Äù overlay */
    .overlay {
      position: fixed; inset: 0;
      background: radial-gradient(1100px 800px at 30% 0%, rgba(88,166,255,.18), rgba(0,0,0,.72) 55%),
                  rgba(0,0,0,.75);
      display:none;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show { display:block; }
    .overlay .panel {
      max-width: 720px; margin: 0 auto;
      border-radius: 22px;
      padding: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(17,26,51,.92), rgba(17,26,51,.75));
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
    }
    .big { font-size: 26px; margin: 2px 0 6px; }
    .timer { font-size: 44px; letter-spacing: 1px; margin: 6px 0 14px; }
    .note { color: rgba(238,242,255,.78); }
    .hr { height:1px; background: rgba(255,255,255,.12); margin: 12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Task Gate</h1>
        <p class="sub">Finish your required tasks. Earn phone time. Simple and annoying (in the best way).</p>
      </div>
      <div class="pill" id="datePill">üìÖ <strong>Today</strong></div>
    </div>

    <div class="split">
      <div class="card">
        <h2>‚úÖ Tasks</h2>
        <div class="tiny" id="progressText">Loading‚Ä¶</div>
        <div class="tasks" id="tasks"></div>

        <div class="hr"></div>

        <h2>‚ûï Add task</h2>
        <label>Task name</label>
        <input id="newTitle" placeholder="Example: 10 pushups, homework, clean desk‚Ä¶" maxlength="60" />
        <div class="row">
          <div style="flex:1; min-width: 180px;">
            <label>Type</label>
            <select id="newType">
              <option value="required" selected>Required (blocks phone time)</option>
              <option value="optional">Optional (nice-to-have)</option>
            </select>
          </div>
          <div style="flex:1; min-width: 180px;">
            <label>Daily reset?</label>
            <select id="newReset">
              <option value="daily" selected>Yes, reset every day</option>
              <option value="never">No, stays done</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="addBtn">Add task</button>
          <button class="btn bad" id="clearDoneBtn" title="Deletes completed tasks (careful)">Delete completed</button>
        </div>
      </div>

      <div class="card">
        <h2>üîì Phone time</h2>
        <div class="row" style="align-items:center;">
          <div class="pill">üî• Streak: <strong id="streak">0</strong></div>
          <div class="pill">üèÅ Required: <strong id="reqStatus">0/0</strong></div>
        </div>

        <label style="margin-top:12px;">Reward length</label>
        <select id="minutes">
          <option value="5">5 minutes</option>
          <option value="10" selected>10 minutes</option>
          <option value="15">15 minutes</option>
          <option value="25">25 minutes</option>
          <option value="45">45 minutes</option>
        </select>

        <div class="row" style="margin-top:12px;">
          <button class="btn good" id="startBtn" disabled>Start phone time</button>
          <button class="btn" id="quickBtn" title="Emergency 2 minutes. Doesn&#39;t increase streak.">2-min emergency</button>
        </div>

        <div class="hr"></div>

        <h2>üß† Rules (you can change later)</h2>
        <p class="tiny">
          ‚Ä¢ ‚ÄúStart phone time‚Äù appears when all <span class="tag req">Required</span> tasks are complete.<br/>
          ‚Ä¢ Daily tasks reset each day.<br/>
          ‚Ä¢ Streak increases when you finish all required tasks that day.
        </p>

        <div class="hr"></div>

        <button class="btn" id="exportBtn">Export data</button>
        <button class="btn" id="importBtn">Import data</button>
        <input type="file" id="importFile" accept="application/json" hidden />
      </div>
    </div>
  </div>

  <!-- Gate overlay (shows during ‚Äúphone time‚Äù) -->
  <div class="overlay" id="gate">
    <div class="panel">
      <div class="pill">üîí Phone time is active</div>
      <div class="big">You earned it.</div>
      <div class="note">When the timer hits 0, come back and finish tasks again.</div>
      <div class="timer" id="timer">00:00</div>
      <div class="row">
        <button class="btn primary" id="closeGateBtn">Close gate (go use phone)</button>
        <button class="btn bad" id="endEarlyBtn">End early</button>
      </div>
      <div class="hr"></div>
      <div class="tiny" id="gateHint">
        Tip: If you want this to feel ‚Äúreal,‚Äù pair it with Focus/Screen Time so your distracting apps are hidden/limited.
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_KEY = "task_gate_v1";
  const $ = (id) => document.getElementById(id);

  const state = {
    tasks: [],
    unlockUntil: 0,
    streak: 0,
    lastDay: "",      // YYYY-MM-DD
    lastStreakDay: "" // YYYY-MM-DD (last day streak was incremented)
  };

  const todayKey = () => new Date().toISOString().slice(0,10); // UTC; good enough for a simple daily reset

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        Object.assign(state, parsed);
      } catch {}
    }
    if (!Array.isArray(state.tasks)) state.tasks = [];
    if (typeof state.unlockUntil !== "number") state.unlockUntil = 0;
    if (typeof state.streak !== "number") state.streak = 0;
    if (typeof state.lastDay !== "string") state.lastDay = "";
    if (typeof state.lastStreakDay !== "string") state.lastStreakDay = "";

    // First run: seed a few starter tasks
    if (state.tasks.length === 0) {
      state.tasks = [
        { id: crypto.randomUUID(), title: "Make bed", type: "required", reset: "daily", done: false, createdAt: Date.now() },
        { id: crypto.randomUUID(), title: "10 minutes of homework", type: "required", reset: "daily", done: false, createdAt: Date.now() },
        { id: crypto.randomUUID(), title: "Drink water", type: "optional", reset: "daily", done: false, createdAt: Date.now() }
      ];
    }

    dailyResetIfNeeded();
    save();
  }

  function save() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function dailyResetIfNeeded() {
    const tk = todayKey();
    if (state.lastDay && state.lastDay !== tk) {
      // Reset daily tasks
      state.tasks.forEach(t => {
        if (t.reset === "daily") t.done = false;
      });
    }
    state.lastDay = tk;
  }

  function requiredCounts() {
    const req = state.tasks.filter(t => t.type === "required");
    const done = req.filter(t => t.done).length;
    return { done, total: req.length };
  }

  function allRequiredDone() {
    const { done, total } = requiredCounts();
    return total === 0 ? false : done === total;
  }

  function maybeAwardStreak() {
    const tk = todayKey();
    if (allRequiredDone() && state.lastStreakDay !== tk) {
      state.streak += 1;
      state.lastStreakDay = tk;
      save();
    }
  }

  function render() {
    // date pill
    const d = new Date();
    $("datePill").innerHTML = `üìÖ <strong>${d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" })}</strong>`;

    // tasks list
    const tasksEl = $("tasks");
    tasksEl.innerHTML = "";

    const sorted = [...state.tasks].sort((a,b) => {
      // Required first, then not-done first, then created
      const typeOrder = (x) => x.type === "required" ? 0 : 1;
      const doneOrder = (x) => x.done ? 1 : 0;
      return typeOrder(a)-typeOrder(b) || doneOrder(a)-doneOrder(b) || a.createdAt-b.createdAt;
    });

    for (const t of sorted) {
      const row = document.createElement("div");
      row.className = "task";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!t.done;
      cb.addEventListener("change", () => {
        t.done = cb.checked;
        save();
        maybeAwardStreak();
        render();
      });

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = t.title;

      const meta = document.createElement("div");
      meta.className = "meta";

      const tag1 = document.createElement("span");
      tag1.className = "tag " + (t.type === "required" ? "req" : "opt");
      tag1.textContent = t.type === "required" ? "Required" : "Optional";

      const tag2 = document.createElement("span");
      tag2.className = "tag";
      tag2.textContent = t.reset === "daily" ? "Daily" : "Sticky";

      const del = document.createElement("button");
      del.className = "btn bad";
      del.style.padding = "8px 10px";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        state.tasks = state.tasks.filter(x => x.id !== t.id);
        save();
        render();
      });

      meta.append(tag1, tag2, del);
      row.append(cb, title, meta);
      tasksEl.appendChild(row);
    }

    // progress text
    const req = requiredCounts();
    const totalDone = state.tasks.filter(t => t.done).length;
    $("progressText").textContent =
      `Done: ${totalDone}/${state.tasks.length} ‚Ä¢ Required: ${req.done}/${req.total}`;

    $("reqStatus").textContent = `${req.done}/${req.total}`;
    $("streak").textContent = String(state.streak);

    // Start button
    const canStart = allRequiredDone();
    $("startBtn").disabled = !canStart;

    // If currently unlocked, show gate
    syncGate();
  }

  function addTask() {
    const title = $("newTitle").value.trim();
    if (!title) return;

    const type = $("newType").value;
    const reset = $("newReset").value;

    state.tasks.push({
      id: crypto.randomUUID(),
      title,
      type,
      reset,
      done: false,
      createdAt: Date.now()
    });
    $("newTitle").value = "";
    save();
    render();
  }

  function deleteCompleted() {
    state.tasks = state.tasks.filter(t => !t.done);
    save();
    render();
  }

  function startUnlock(minutes, countsTowardStreak = true) {
    const ms = minutes * 60 * 1000;
    state.unlockUntil = Date.now() + ms;
    save();
    if (countsTowardStreak) maybeAwardStreak();
    syncGate(true);
  }

  function endUnlock() {
    state.unlockUntil = 0;
    save();
    syncGate(false);
  }

  function fmtMMSS(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    const mm = String(Math.floor(s / 60)).padStart(2,"0");
    const ss = String(s % 60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  let timerHandle = null;

  function syncGate(forceShow = false) {
    const gate = $("gate");
    const now = Date.now();
    const remaining = state.unlockUntil - now;

    const active = forceShow || remaining > 0;

    if (active) {
      gate.classList.add("show");
      $("timer").textContent = fmtMMSS(remaining);

      if (!timerHandle) {
        timerHandle = setInterval(() => {
          const rem = state.unlockUntil - Date.now();
          $("timer").textContent = fmtMMSS(rem);
          if (rem <= 0) {
            clearInterval(timerHandle);
            timerHandle = null;
            endUnlock();
            render();
          }
        }, 250);
      }
    } else {
      gate.classList.remove("show");
      if (timerHandle) {
        clearInterval(timerHandle);
        timerHandle = null;
      }
    }
  }

  function exportData() {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "task-gate-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importData(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(String(reader.result));
        if (!parsed || !Array.isArray(parsed.tasks)) throw new Error("Bad file");
        Object.assign(state, parsed);
        dailyResetIfNeeded();
        save();
        render();
      } catch {
        alert("Import failed. Make sure you selected a Task Gate backup JSON file.");
      }
    };
    reader.readAsText(file);
  }

  // Wire up UI
  $("addBtn").addEventListener("click", addTask);
  $("newTitle").addEventListener("keydown", (e) => {
    if (e.key === "Enter") addTask();
  });
  $("clearDoneBtn").addEventListener("click", deleteCompleted);

  $("startBtn").addEventListener("click", () => {
    const minutes = parseInt($("minutes").value, 10);
    startUnlock(minutes, true);
  });

  $("quickBtn").addEventListener("click", () => startUnlock(2, false));

  $("closeGateBtn").addEventListener("click", () => {
    // This just hides the overlay momentarily by ending unlock early is optional.
    // We keep it active; closing means ‚Äúgo use phone‚Äù.
    $("gate").classList.remove("show");
    setTimeout(() => syncGate(false), 250);
  });

  $("endEarlyBtn").addEventListener("click", endUnlock);

  $("exportBtn").addEventListener("click", exportData);
  $("importBtn").addEventListener("click", () => $("importFile").click());
  $("importFile").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if (f) importData(f);
    e.target.value = "";
  });

  // PWA / Service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // Boot
  load();
  render();
})();
</script>
</body>
</html>
